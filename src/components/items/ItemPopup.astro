---
import Popup from "../Popup.astro";
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import { X } from "@lucide/astro";
import plansData from '../../data/plans_data.json';

const { item, t, popupId } = Astro.props;

const locale = Astro.currentLocale || "zh-Hant";

const markdownFiles = import.meta.glob<{ Content: any }>('./markdown/**/*.md', { eager: true });

// Try to load markdown content for this item
let MarkdownContent = null;
let hasMarkdownContent = false;

const markdownPath = `./markdown/${item.id}/${locale}.md`;
const markdownModule = markdownFiles[markdownPath];

if (markdownModule && markdownModule.Content) {
	MarkdownContent = markdownModule.Content;
	hasMarkdownContent = true;
} else {
	// Fallback to regular description if markdown file doesn't exist
	console.log(`No markdown found for item ${item.id} in locale ${locale}`);
	hasMarkdownContent = false;
}

// Import images dynamically using import.meta.glob
const images = import.meta.glob<{ default: ImageMetadata }>('./markdown/**/image.jpg');
const imagePath = `./markdown/${item.id}/image.jpg`;

// Find the matching plan row for this item
const planRow = plansData.rows.find(row => row.id === item.id);
const shouldShowPlanTiers = planRow !== undefined;
---

<Popup
	id={popupId || `plan-popup-${item.id}`}
	title={t.item_titles[item.title]}
	button={false}
	hero={false}
>
	<div class="popup-content">
		<div class="item-details">
			<div class="item-meta">
				<span class="remaining">{t.remaining} {item.remaining} {item.unit}</span>
				<span class="category">{`${new Date(item.deadline).getMonth() + 1}/${new Date(item.deadline).getDate()}`} {t.deadline}</span>
			</div>
			<h3>{item.title}</h3>
			<div class="item-price">
				<span class="price-value">{item.price}</span>
			</div>

			{shouldShowPlanTiers && planRow && (
				<div class="plan-tiers">
					{plansData.tiers.map((tier, index) => {
						const value = planRow.values[index];
						let displayText = "0";
						let unit = "";

						if (value.textKey === "not_available") {
							displayText = "0";
						} else if ('number' in value && value.number !== undefined) {
							displayText = value.number.toString();
							if ('unitKey' in value && value.unitKey) {
								// Follow the same pattern as Plans.astro - use only the last part of unitKey
								const unitKey = value.unitKey.split('.').pop();
								unit = unitKey ? t.unit[unitKey] || "" : "";
							}
						} else if ('icon' in value && value.icon !== undefined) {
							displayText = value.icon.toString();
							// For icon values, we can use a default unit if needed
							unit = "個"; // or whatever unit makes sense for icons
						} else {
							// For other types (main, textKey that aren't not_available), don't show anything
							displayText = "0";
						}

						return (
							<div class="tier-item" style={`color: ${tier.textColor}`}>
								<span class="tier-name">{t.tier_names[tier.name]}</span>
								<span class="tier-arrow">→</span>
								{displayText === "0" ? (
									<span class="tier-value tier-unavailable">
										<X size={20} />
									</span>
								) : (
									<span class="tier-value">{displayText} {unit}</span>
								)}
							</div>
						);
					})}
				</div>
			)}

			{hasMarkdownContent ? (
				<div class="markdown-content">
					<MarkdownContent />
				</div>
			) : (
				<p class="item-description">{item.description}</p>
			)}
		</div>
		<div class="item-image">
			{images[imagePath] ? (
				<Image src={images[imagePath]()} alt={item.title} />
			) : (
				<img src={item.image} alt={item.title} />
			)}
		</div>
	</div>
</Popup>

<style is:global>
	.popup-content {
		padding: 2rem 0;
		display: grid;
		grid-template-columns: 1fr;
		gap: 2rem;
		height: calc(100vh - 6.2rem);
		min-height: 600px;
	}

	/* Desktop and tablet layout */
	@media (min-width: 769px) {
		.popup-content {
			grid-template-columns: 2fr 3fr;
			gap: 0;
			padding: 0;
		}
	}

	.item-details {
		padding: 2rem 3rem;
		display: flex;
		flex-direction: column;
		justify-content: flex-start;
		overflow-y: auto;
		height: 100%;
	}

	.item-details h3 {
		font-size: 2.5rem;
		color: var(--black);
		margin-bottom: 1rem;
		font-weight: 700;
	}

	.item-description {
		font-size: 1.2rem;
		line-height: 1.6;
		color: var(--black);
		margin-bottom: 1.5rem;
	}

	.price-value {
		font-size: 1.4rem;
		color: var(--black);
		font-weight: 700;
		display: block;
	}

	.item-meta {
		display: flex;
		gap: 1rem;
		align-items: center;
		margin-bottom: 1rem;
	}

	.remaining {
		background-color: #F6D46C;
		padding: 0.1rem 0.7rem;
		border-radius: 20px;
		font-size: 0.9rem;
		font-weight: 500;
	}

	.category {
		background-color: #69F147;
    padding: 0.1rem 0.7rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
	}

	.item-image {
		display: flex;
		align-items: center;
		justify-content: center;
		overflow: hidden;
		order: 1;
	}

	.item-details {
		order: 2;
	}

	.item-image img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		border-radius: 0;
	}

	/* Desktop and tablet image styles */
	@media (min-width: 769px) {
		.item-image {
			height: 100%;
			order: 0;
		}

		.item-details {
			order: 0;
		}

		.item-image img {
			border-radius: 0 25px 25px 0;
		}
	}


	.plan-tiers {
		margin: 1rem 0;
		padding: 0;
	}

	.tier-item {
		display: flex;
		align-items: center;
		margin-bottom: 0.8rem;
		font-size: 1.3rem;
		font-weight: 600;
	}

	.tier-item:last-child {
		margin-bottom: 0;
	}

	.tier-name {
		font-weight: 700;
		font-size: 1.4rem;
	}

	.tier-arrow {
		margin: 0 1.5rem;
		font-weight: 700;
		opacity: 0.7;
		font-size: 1.3rem;
	}

	.tier-value {
		font-weight: 700;
		font-size: 1.5rem;
	}

	.tier-unavailable {
		display: flex;
		align-items: center;
		justify-content: center;
		opacity: 0.6;
	}

	.tier-unavailable svg {
		width: 24px;
		height: 24px;
	}

	@media (max-width: 768px) {
		.popup-content {
			padding: 1.5rem 0;
			gap: 2rem;
			height: auto;
		}

		.item-details {
			padding: 0 2rem;
		}

		.item-details h3 {
			font-size: 2rem;
		}

		.item-image {
			height: 250px;
			margin: 0 2rem;
		}

		.item-image img {
			border-radius: 15px;
		}

		.plan-tiers {
			margin: 0.8rem 0;
			padding: 0;
		}

		.tier-item {
			font-size: 1.1rem;
			margin-bottom: 0.6rem;
		}

		.tier-arrow {
			font-size: 1.1rem;
			margin: 0 1rem;
		}

		.tier-value {
			font-size: 1.3rem;
		}

		.tier-unavailable svg {
			width: 20px;
			height: 20px;
		}
	}
</style>

---
import Popup from "../Popup.astro";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import { X, Plus, Minus, ChevronLeft, ChevronRight, Check } from "@lucide/astro";
import planData from "@data/plan.json";
import { marked } from "marked";

import type { SubItem } from "../../utils/items-loader";

const { item, t, popupId } = Astro.props;

// Import images dynamically using import.meta.glob
const images = import.meta.glob<{ default: ImageMetadata }>("../../assets/img/items/*");
const imagePath = `../../assets/img/items/${item.image}`;

// Find this item in plan.json benefits and collect tier info
const tiers = [
	{ id: "navigator", name: planData.navigator.name_zh, nameEn: planData.navigator.name_en, textColor: "#FF928A", data: planData.navigator },
	{ id: "deep_cultivation", name: planData.deep_cultivation.name_zh, nameEn: planData.deep_cultivation.name_en, textColor: "#537FF1", data: planData.deep_cultivation },
	{ id: "visionary", name: planData.visionary.name_zh, nameEn: planData.visionary.name_en, textColor: "#6FD195", data: planData.visionary },
	{ id: "new_sprout", name: planData.new_sprout.name_zh, nameEn: planData.new_sprout.name_en, textColor: "#77B55A", data: planData.new_sprout }
];

// Check if this item appears in any plan tier
const tierBenefits = tiers.map(tier => {
	const benefit = tier.data.benefits.find(b => b.item_id === item.id);
	return {
		tier: tier,
		benefit: benefit,
		quantity: benefit?.quantity || ""
	};
});

const shouldShowPlanTiers = tierBenefits.some(tb => tb.benefit !== undefined);
---

<Popup id={popupId || `plan-popup-${item.id}`} button={false} hero={false}>
	<div class="popup-content" data-item-id={item.id}>
		<div class="item-image">
			{
				(() => {
					// Filter sub-items that have images
					const subItemsWithImages = item.sub ? item.sub.filter((subItem: SubItem) => subItem.image && subItem.image.trim() !== "") : [];
					const hasMultipleImages = subItemsWithImages.length > 0;

					if (hasMultipleImages) {
						// Show carousel with main item image first, then sub-item images
						return (
							<div class="image-carousel" data-item-id={item.id}>
								<div class="carousel-images">
									{/* Main item image as first slide */}
									<div class="carousel-slide active" data-slide-index={0} data-description={item.image_description || ""}>
										{images[imagePath] ? (
											<Image src={images[imagePath]()} alt={item.image_description || item.name} />
										) : (
											<img src={item.image} alt={item.image_description || item.name} />
										)}
									</div>
									{/* Sub-item images */}
									{subItemsWithImages.map((subItem: SubItem, index: number) => {
										const subImagePath = `../../assets/img/items/${subItem.image}`;
										const subImageDescription = subItem.image_description;
										const slideIndex = index + 1; // +1 because main image is at index 0

										return (
											<div class="carousel-slide" data-slide-index={slideIndex} data-description={subImageDescription || ""}>
												{images[subImagePath] ? (
													<Image src={images[subImagePath]()} alt={subImageDescription || subItem.name} />
												) : (
													<img src={subItem.image} alt={subImageDescription || subItem.name} />
												)}
											</div>
										);
									})}
								</div>
								<button class="carousel-btn carousel-prev" aria-label="Previous image">
									<ChevronLeft />
								</button>
								<button class="carousel-btn carousel-next" aria-label="Next image">
									<ChevronRight />
								</button>
								<div class="carousel-description" />
							</div>
						);
					} else {
						// Show only main item image (no carousel needed)
						return images[imagePath] ? (
							<Image src={images[imagePath]()} alt={item.image_description || item.name} />
						) : (
							<img src={item.image} alt={item.image_description || item.name} />
						);
					}
				})()
			}
		</div>
		<div class="item-details">
			<div class="item-meta">
				{item.quantity === "獨家" && <span class="exclusive">{t.exclusive}</span>}
				{item.quantity === "打包專屬" && <span class="package-exclusive">{t.package_exclusive}</span>}
				{item.quantity !== "獨家" && item.quantity !== "打包專屬" && (
					<span class="remaining" data-initial-remaining={item.remaining} data-unit={t.unit[item.unit] || item.unit}>{t.remaining} {item.remaining} {t.unit[item.unit] || item.unit}</span>
				)}
				<span class="category">{`${new Date(item.deadline).getMonth() + 1}/${new Date(item.deadline).getDate()}`} {t.deadline}</span>
			</div>
			<div class="title-row">
				<h3>{item.name}</h3>
			</div>
			{
				item.price && (
					<div class="item-price">
						<span class="price-value">{item.price}</span>
					</div>
				)
			}

			{
				item.sub && item.sub.length > 0 && (
					<div class="sub-items-section">
						{item.sub.map((subItem: SubItem, index: number) => {
							const subItemId = `${item.id}-sub-${index}`;

							return (
								<div class="sub-item" data-sub-item-id={subItemId}>
									<span class={"sub-item-name" + (subItem.name.length > 8 ? " long" :"")}>{subItem.name}</span>
									<span class="sub-item-price">{subItem.price}</span>
									<div
										class="sub-item-controls"
										data-item-id={item.id}
										data-sub-item-id={subItemId}
										data-sub-item-name={subItem.name}
										data-sub-item-remaining={subItem.remaining || ""}
										data-initial-sub-item-remaining={subItem.remaining || ""}
									>
										<button type="button" class="sub-quantity-btn minus" aria-label={`Decrease ${subItem.name} quantity`}>
											<Minus size={12} />
										</button>
										<span class="sub-quantity-display" role="status" aria-live="polite">
											0
										</span>
										<button type="button" class="sub-quantity-btn plus" aria-label={`Increase ${subItem.name} quantity`}>
											<Plus size={12} />
										</button>
									</div>
								</div>
							);
						})}
					</div>
				)
			}

			{
				shouldShowPlanTiers && (
					<div class="plan-tiers">
						{tierBenefits.map(tb => {
							const quantity = tb.quantity;
							const isCheckmark = quantity === "O" || quantity === "o";
							const isAvailable = quantity && quantity !== "";

							return (
								<div class="tier-item" style={`color: ${tb.tier.textColor}`}>
									<span class="tier-name">{tb.tier.name}</span>
									<span class="tier-arrow">→</span>
									{!isAvailable ? (
										<span class="tier-value tier-unavailable">
											<X size={20} />
										</span>
									) : isCheckmark ? (
										<span class="tier-value">
											<Check size={20} />
										</span>
									) : (
										<span class="tier-value">{quantity}</span>
									)}
								</div>
							);
						})}
					</div>
				)
			}

			<div class="structured-descriptions">
				{
					item.global_description && (
						<div set:html={marked.parse(item.global_description)} />
					)
				}

				{
					item.talent_recruitment && (
						<>
							<h2>{t.item_categories.talent_recruitment}</h2>
							<div set:html={marked.parse(item.talent_recruitment)} />
						</>
					)
				}

				{
					item.brand_exposure && (
						<>
							<h2>{t.item_categories.brand_exposure}</h2>
							<div set:html={marked.parse(item.brand_exposure)} />
						</>
					)
				}

				{
					item.product_promotion && (
						<>
							<h2>{t.item_categories.product_promotion}</h2>
							<div set:html={marked.parse(item.product_promotion)} />
						</>
					)
				}
			</div>
		</div>
	</div>
</Popup>

<style is:global>
	.popup-content {
		display: grid;
		grid-template-columns: 2fr 3fr;
		height: calc(100vh - 9rem);
		min-height: 600px;
	}

	.item-details {
		padding: 3rem;
		display: flex;
		flex-direction: column;
		justify-content: flex-start;
		gap: 1rem;
		overflow-y: auto;
		height: 100%;
		break-inside: avoid;
	}

	.title-row {
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: 1rem;
	}

	.item-details h3 {
		font-size: 2.5rem;
		color: var(--black);
		flex: 1;
	}

	.item-description {
		font-size: 1.2rem;
		line-height: 1.6;
		color: var(--black);
		margin-bottom: 1.5rem;
	}

	.price-value {
		font-size: 1.4rem;
		color: var(--black);
		font-weight: 700;
		font-family: "Fira Mono", monospace;
	}

	.quantity-controls {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.quantity-btn {
		width: 1.8rem;
		aspect-ratio: 1 / 1;
		border-radius: 50%;
		background-color: var(--black);
		color: var(--white);
		border: none;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.2rem;
		font-weight: 400;
		transition: transform 0.2s ease;
		line-height: 1;
	}

	.quantity-btn:hover {
		transform: scale(1.1);
	}

	.quantity-btn:disabled {
		opacity: 0.3;
		cursor: not-allowed;
	}

	.quantity-btn:disabled:hover {
		transform: scale(1);
	}

	.quantity-display {
		font-size: 1.2rem;
		font-weight: 600;
		color: var(--black);
		min-width: 1.5rem;
		text-align: center;
	}

	.item-meta {
		display: flex;
		gap: 0.8rem;
		align-items: center;
		flex-wrap: wrap;
	}

	.exclusive {
		background-color: #ff9999;
		padding: 0.1rem 0.7rem;
		border-radius: 20px;
		font-size: 0.9rem;
		font-weight: 500;
	}

	.package-exclusive {
		background-color: #9999ff;
		padding: 0.1rem 0.7rem;
		border-radius: 20px;
		font-size: 0.9rem;
		font-weight: 500;
	}

	.remaining {
		background-color: #f6d46c;
		padding: 0.1rem 0.7rem;
		border-radius: 20px;
		font-size: 0.9rem;
		font-weight: 500;
	}

	.category {
		background-color: #69f147;
		padding: 0.1rem 0.7rem;
		border-radius: 20px;
		font-size: 0.9rem;
		font-weight: 500;
	}

	.item-image {
		display: flex;
		align-items: center;
		justify-content: center;
		overflow: hidden;
		background-color: var(--gray-container);
		border-radius: 25px 0 0 25px;
	}
	.item-image img {
		width: 100%;
		height: 100%;
		object-fit: contain;
		color: transparent;
	}

	/* Carousel styles */
	.image-carousel {
		position: relative;
		width: 100%;
		height: 100%;
		display: flex;
		flex-direction: column;
	}

	.carousel-images {
		position: relative;
		flex: 1;
		overflow: hidden;
	}

	.carousel-slide {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		opacity: 0;
		transition: opacity 0.3s ease;
		pointer-events: none;
	}

	.carousel-slide.active {
		opacity: 1;
		pointer-events: auto;
	}

	.carousel-btn {
		position: absolute;
		top: 50%;
		transform: translateY(-50%);
		background-color: #ffffff4a;
		color: white;
		border: none;
		width: 3rem;
		height: 3rem;
		border-radius: 50%;
		cursor: pointer;
		font-size: 2rem;
		line-height: 1;
		display: flex;
		align-items: center;
		justify-content: center;
		transition:
			background-color 0.2s ease,
			transform 0.2s ease;
		z-index: 10;
	}

	.carousel-btn:hover:not(:disabled) {
		background-color: rgba(0, 0, 0, 0.7);
		transform: translateY(-50%) scale(1.1);
	}

	.carousel-btn:disabled {
		opacity: 0.3;
		cursor: not-allowed;
	}

	.carousel-prev {
		left: 1rem;
	}

	.carousel-next {
		right: 1rem;
	}

	/* Carousel description styles */
	.carousel-description {
		position: absolute;
		bottom: 1.5rem;
		right: 1.5rem;
		background: #e0e0e0b2;
		color: #1a1a1a;
		padding: 0.75rem 1.25rem;
		border-radius: 16px;
		font-size: 1rem;
		font-weight: 500;
		max-width: 80%;
		z-index: 10;
		backdrop-filter: blur(40px) saturate(180%);
		-webkit-backdrop-filter: blur(40px) saturate(180%);
		line-height: 1.4;
		opacity: 0;
		transition: opacity 0.3s ease;
	}

	.carousel-description:not(:empty) {
		opacity: 1;
	}

	.tier-item {
		display: flex;
		align-items: center;
		font-size: 1.3rem;
		font-weight: 600;
	}

	.tier-name {
		font-weight: 700;
		font-size: 1.4rem;
	}

	.tier-arrow {
		margin: 0 1.5rem;
		font-weight: 700;
		opacity: 0.7;
		font-size: 1.3rem;
	}

	.tier-value {
		font-weight: 700;
		font-size: 1.5rem;
		display: flex;
		align-items: center;
	}

	.tier-unavailable {
		display: flex;
		align-items: center;
		justify-content: center;
		opacity: 0.6;
	}

	.tier-unavailable svg {
		width: 24px;
		height: 24px;
	}

	.sub-items-section h4 {
		font-size: 2rem;
		margin-bottom: 1rem;
		font-weight: 700;
		color: var(--black);
	}

	.sub-item {
		display: flex;
		align-items: center;
		flex-wrap: wrap;
		gap: 1rem;
		margin-bottom: 0.5rem;
		font-family: "Fira Mono", monospace;
	}

	.sub-item-name {
		font-size: 1.3rem;
		font-weight: 700;
		color: var(--black);
		flex: 1;
	}

	.sub-item-price {
		color: rgba(0, 0, 0, 0.6);
		font-size: 1.1rem;
	}

	.sub-item-controls {
		display: flex;
		align-items: center;
		gap: 0.65rem;
	}

	.sub-quantity-btn {
		width: 1.5rem;
		aspect-ratio: 1 / 1;
		border-radius: 50%;
		background-color: #45454c;
		color: var(--white);
		border: none;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1rem;
		font-weight: 400;
		transition: transform 0.2s ease;
		line-height: 1;
	}

	.sub-quantity-btn svg {
		display: block;
	}

	.sub-quantity-btn:hover {
		transform: scale(1.1);
	}

	.sub-quantity-btn:disabled {
		opacity: 0.3;
		cursor: not-allowed;
	}

	.sub-quantity-btn:disabled:hover {
		transform: scale(1);
	}

	.sub-quantity-display {
		font-size: 1rem;
		font-weight: 600;
		color: var(--black);
		text-align: center;
	}

	.structured-descriptions {
		margin-top: 1rem;
	}

	.structured-descriptions h2 {
		font-size: 1.5rem;
		margin-bottom: 0.3rem;
		margin-top: 1.2rem;
		text-align: left;
	}

	.structured-descriptions h2:first-child {
		margin-top: 0;
	}

	@media screen and (max-width: 900px) {
		.popup-content {
			grid-template-columns: 1fr;
			height: unset;
		}

		.item-image {
			border-radius: 25px 25px 0 0;
			height: 15rem;
		}

		.carousel-description {
			font-size: 0.9rem;
			max-width: 90%;
		}

		.item-details {
			padding: 2rem 2rem 7rem;
		}
	}
	@media screen and (max-width: 40rem) {
		.sub-item-name.long {
			flex: 1 1 100%;
			margin-bottom: 0.5rem;
		}
	}

	@media print {
		.popup-content {
			height: unset;
			min-height: unset;
		}

		.carousel-btn,
		.sub-item-controls,
		.quantity-controls {
			display: none;
		}

		.item-details {
			padding: 20pt;
		}

		.item-details h3 {
			font-size: 24pt;
			margin-bottom: 0;
		}

		.structured-descriptions h2 {
			font-size: 14pt;
			margin-bottom: 0;
			margin-top: 5pt;
		}

		.structured-descriptions {
			margin-top: 5pt;
		}

		.tier-name,
		.tier-arrow,
		.tier-value,
		.sub-item-name,
		.sub-item-price {
			font-size: 12pt;
		}

		.price-value {
			font-size: 14pt;
		}

		.item-details {
			gap: 7pt;
		}
	}
</style>

<script>
	import { addInterestedItem, removeInterestedItem, updateItemQuantity, getItemQuantity } from "../../utils/local-storage.ts";

	// Constants
	const UNLIMITED_TEXT = "不限";
	const QUANTITY_PATTERN = /max\s+(\d+)/i;

	document.addEventListener("DOMContentLoaded", function () {
		// Parse quantity from item.quantity field (e.g., "max 5", "不限", "獨家", "打包專屬")
		function parseQuantityLimit(quantityStr: string): number | null {
			if (!quantityStr) return null;
			if (quantityStr === UNLIMITED_TEXT) return null; // unlimited

			const match = quantityStr.match(QUANTITY_PATTERN);
			if (match) return parseInt(match[1], 10);

			return null;
		}

		// Parse max quantity from remaining string (handles direct numbers or "max X" format)
		function parseMaxQuantity(remainingStr: string): number | null {
			if (!remainingStr) return null;

			// Try parsing as a direct number first
			const directNum = parseInt(remainingStr, 10);
			if (!isNaN(directNum)) {
				return directNum;
			}

			// Try parsing "max X" format
			return parseQuantityLimit(remainingStr);
		}

		// Calculate effective max quantity (minimum of remaining and max per order)
		function calculateMaxQuantity(quantityStr: string, remainingStr: string): number | null {
			const maxPerOrder = parseQuantityLimit(quantityStr);
			const remaining = parseInt(remainingStr, 10);

			if (!isNaN(remaining)) {
				return maxPerOrder !== null && maxPerOrder < remaining ? maxPerOrder : remaining;
			}
			return maxPerOrder;
		}


		// Sync sub-item quantity controls with localStorage (treats sub-items as regular items)
		function syncSubItemControls(subItemId: string) {
			try {
				const controls = document.querySelector(`.sub-item-controls[data-sub-item-id="${subItemId}"]`) as HTMLElement;
				if (!controls) return;

				const display = controls.querySelector(".sub-quantity-display") as HTMLElement;
				const minusBtn = controls.querySelector(".sub-quantity-btn.minus") as HTMLButtonElement;
				const plusBtn = controls.querySelector(".sub-quantity-btn.plus") as HTMLButtonElement;

				const currentQty = getItemQuantity(subItemId) || 0;
				if (display) display.textContent = currentQty.toString();

				// Set max quantity to 99 for sub-items
				const maxQuantity = 99;

				// Disable plus button if at max quantity
				if (plusBtn) {
					plusBtn.disabled = currentQty >= maxQuantity;
				}

				// Disable minus button if at 0
				if (minusBtn) {
					minusBtn.disabled = currentQty <= 0;
				}
			} catch (error) {
				if (import.meta.env.DEV) console.error("Error syncing sub-item controls:", error);
			}
		}

		// Handle quantity controls
		document.addEventListener("click", function (e) {
			const target = e.target as Element;

			// Sub-item Plus button (treat sub-items as regular items)
			if (target.closest(".sub-quantity-btn.plus")) {
				e.preventDefault();
				e.stopPropagation();

				const btn = target.closest(".sub-quantity-btn.plus") as HTMLButtonElement;
				const controls = btn.closest(".sub-item-controls");
				if (!controls) return;

				const subItemId = controls.getAttribute("data-sub-item-id");
				if (!subItemId) return;

				const currentQty = getItemQuantity(subItemId) || 0;
				const newQty = currentQty + 1;

				if (currentQty === 0) {
					// Get item data from popup (same as regular item)
					const popup = controls.closest(".popup-content");
					const subItemName = controls.getAttribute("data-sub-item-name") || "";
					const img = popup?.querySelector(".item-image img");
					const itemImage = img?.getAttribute("src") || "";
					const deadlineEl = popup?.querySelector(".category");
					const itemDeadline = deadlineEl?.textContent || "";

					// Set max quantity to 99 for sub-items
					const maxQuantity = 99;

					// Add item to cart with quantity 1
					addInterestedItem({
						id: subItemId,
						title: subItemName,
						category: "all",
						image: itemImage,
						deadline: itemDeadline,
						quantity: 1,
						maxQuantity: maxQuantity
					});
				} else {
					// Update existing quantity
					updateItemQuantity(subItemId, newQty);
				}

				syncSubItemControls(subItemId);
			}

			// Sub-item Minus button (treat sub-items as regular items)
			if (target.closest(".sub-quantity-btn.minus")) {
				e.preventDefault();
				e.stopPropagation();

				const btn = target.closest(".sub-quantity-btn.minus") as HTMLButtonElement;
				const controls = btn.closest(".sub-item-controls");
				if (!controls) return;

				const subItemId = controls.getAttribute("data-sub-item-id");
				if (!subItemId) return;

				const currentQty = getItemQuantity(subItemId) || 0;
				if (currentQty <= 0) return;

				const newQty = currentQty - 1;

				if (newQty === 0) {
					// Remove from cart when quantity reaches 0
					removeInterestedItem(subItemId);
				} else {
					updateItemQuantity(subItemId, newQty);
				}

				syncSubItemControls(subItemId);
			}

		});

		// Listen to itemsChange events from localStorage
		window.addEventListener("itemsChange", function () {
			// Sync all sub-item controls
			document.querySelectorAll(".sub-item-controls").forEach(controls => {
				const subItemId = controls.getAttribute("data-sub-item-id");
				if (subItemId) {
					syncSubItemControls(subItemId);
				}
			});
		});

		// Initial sync for sub-items on page load
		document.querySelectorAll(".sub-item-controls").forEach(controls => {
			const subItemId = controls.getAttribute("data-sub-item-id");
			if (subItemId) {
				syncSubItemControls(subItemId);
			}
		});

		// Carousel functionality
		function initCarousels() {
			document.querySelectorAll(".image-carousel").forEach(carousel => {
				try {
					const slides = carousel.querySelectorAll(".carousel-slide");
					const prevBtn = carousel.querySelector(".carousel-prev") as HTMLButtonElement;
					const nextBtn = carousel.querySelector(".carousel-next") as HTMLButtonElement;

					if (slides.length === 0) return;

					let currentIndex = 0;
					const descriptionEl = carousel.querySelector(".carousel-description") as HTMLElement;

					// Add error handling for images
					slides.forEach(slide => {
						const img = slide.querySelector("img");
						if (img) {
							img.addEventListener("error", () => {
								if (import.meta.env.DEV) console.error("Failed to load image:", img.src);
							});
						}
					});

					function updateCarousel() {
						slides.forEach((slide, index) => {
							slide.classList.toggle("active", index === currentIndex);
						});

						// Update description text
						if (descriptionEl) {
							const currentSlide = slides[currentIndex];
							const description = currentSlide.getAttribute("data-description") || "";
							descriptionEl.textContent = description;
						}
					}

					function goToPrev() {
						if (currentIndex > 0) {
							currentIndex--;
						} else {
							// Loop to last slide
							currentIndex = slides.length - 1;
						}
						updateCarousel();
					}

					function goToNext() {
						if (currentIndex < slides.length - 1) {
							currentIndex++;
						} else {
							// Loop to first slide
							currentIndex = 0;
						}
						updateCarousel();
					}

					// Event listeners
					if (prevBtn) {
						prevBtn.addEventListener("click", e => {
							e.preventDefault();
							e.stopPropagation();
							goToPrev();
						});
					}

					if (nextBtn) {
						nextBtn.addEventListener("click", e => {
							e.preventDefault();
							e.stopPropagation();
							goToNext();
						});
					}

					// Keyboard navigation
					carousel.addEventListener("keydown", e => {
						const keyEvent = e as KeyboardEvent;
						if (keyEvent.key === "ArrowLeft") {
							keyEvent.preventDefault();
							goToPrev();
						} else if (keyEvent.key === "ArrowRight") {
							keyEvent.preventDefault();
							goToNext();
						}
					});

					// Make carousel focusable for keyboard navigation
					(carousel as HTMLElement).setAttribute("tabindex", "0");

					// Initialize
					updateCarousel();
				} catch (error) {
					if (import.meta.env.DEV) console.error("Error initializing carousel:", error);
				}
			});
		}

		// Initialize carousels on page load
		initCarousels();
	});
</script>

---
import { loadItemsData } from "../../utils/items-loader";
import ItemPopup from "@components/items/ItemPopup.astro";

const { t, lang } = Astro.props;
const itemsUnsorted = await loadItemsData(lang); // Keep all items including "打包專屬"
// Sort items by order field for initial "all" category display
const items = itemsUnsorted.sort((a, b) => {
	const orderA = a.order || 0;
	const orderB = b.order || 0;
	return orderA - orderB;
});
---

{items.map(item => <ItemPopup item={item} t={t} lang={lang} popupId={`item-popup-${item.id}`} />)}

<script>
	import { getInterestedItems, removeInterestedItem, isItemInterested, isDeadlinePassed } from "../../utils/local-storage.ts";
	import { initializeAddToCart, updateAddButtonStates } from "../../utils/add-to-cart-handler.ts";

	// Wait for DOM to be ready before initializing add-to-cart functionality
	document.addEventListener("DOMContentLoaded", function () {
		// Initialize add-to-cart functionality with card click handler
		initializeAddToCart({
			onCardClick: (itemId: string) => {
				const popupId = `item-popup-${itemId}`;
				window.popupCtrl(popupId, "open");
			}
		});
	});

	const expandButton = document.getElementById("expandButton");
	const cardsContainer = document.querySelector(".cards-container");
	const showText = expandButton ? expandButton.querySelector(".show-text") : null;
	const hideText = expandButton ? expandButton.querySelector(".hide-text") : null;
	const arrow = expandButton ? expandButton.querySelector(".arrow") : null;

	let isExpanded = false,
		canExpand = true,
		isInitialLoad = true;

	const applyExpandState = () => {
		const shouldShowExpandedUI = !canExpand || isExpanded;

		if (shouldShowExpandedUI) {
			cardsContainer!.classList.remove("fade-active");
			cardsContainer!.classList.add("fade-hidden");
			(showText as HTMLElement).style.display = "none";
			(hideText as HTMLElement).style.display = "inline";
			(arrow as HTMLElement).style.transform = "rotate(180deg)";
		} else {
			cardsContainer!.classList.remove("fade-hidden");
			cardsContainer!.classList.add("fade-active");
			(showText as HTMLElement).style.display = "inline";
			(hideText as HTMLElement).style.display = "none";
			(arrow as HTMLElement).style.transform = "rotate(0deg)";

			// Only scroll when collapsing via button click, not on initial page load
			if (!isInitialLoad) {
				const itemsSection = document.getElementById("items");
				if (itemsSection) {
					const yOffset = -20;
					const y = itemsSection.getBoundingClientRect().top + window.pageYOffset + yOffset;
					window.scrollTo({ top: y, behavior: "smooth" });
				}
			}
		}
	};

	if (expandButton)
		expandButton.addEventListener("click", () => {
			isExpanded = !isExpanded;
			isInitialLoad = false; // Mark that user has interacted
			applyExpandState();
		});

	const getVisibleCards = (cards: HTMLElement[]): HTMLElement[] => cards.filter(card => !card.classList.contains("package-exclusive-item"));

	const isCardInactive = (card: HTMLElement) => {
		const soldOut = card.getAttribute("data-is-sold-out") === "true";
		const deadline = card.getAttribute("data-deadline") || "";
		return soldOut || isDeadlinePassed(deadline);
	};

	const sortCards = (selectedCategory: string) => {
		const cardsGrid = document.querySelector(".cards-grid");
		if (!cardsGrid) return;

		const cards = Array.from(cardsGrid.querySelectorAll(".card")) as HTMLElement[];
		// Count only visible cards (exclude package-exclusive-item)
		let visibleCount = getVisibleCards(cards).length;

		let orderAttr = "data-order";
		if (selectedCategory === "talent_recruitment") {
			orderAttr = "data-talent-recruitment-order";
		} else if (selectedCategory === "brand_exposure") {
			orderAttr = "data-brand-exposure-order";
		} else if (selectedCategory === "product_promotion") {
			orderAttr = "data-product-promotion-order";
		}

		cards.sort((a, b) => {
			const aInactive = isCardInactive(a);
			const bInactive = isCardInactive(b);

			// Inactive items (sold out or deadline passed) should always go last
			if (aInactive && !bInactive) return 1;
			if (!aInactive && bInactive) return -1;

			const orderA = parseInt(a.getAttribute(orderAttr) || (selectedCategory === "all" ? "0" : "999999"));
			const orderB = parseInt(b.getAttribute(orderAttr) || (selectedCategory === "all" ? "0" : "999999"));
			return orderA - orderB;
		});

		// Update ItemCard descriptions based on selected category
		cards.forEach(card => {
			updateCardDescription(card, selectedCategory);
		});

		// Reorder cards in the DOM
		cards.forEach(card => cardsGrid.appendChild(card));

		updateExpandButtonVisibility(visibleCount);
	};

	const getCardsPerRowThreshold = () => {
		const width = window.innerWidth;
		if (width <= 768) {
			return 2;
		} else if (width <= 1024) {
			return 4;
		} else {
			return 6;
		}
	};

	const updateCardDescription = (card: HTMLElement, selectedCategory: string) => {
		const descriptionElement = card.querySelector(".description");
		if (!descriptionElement) return;

		// Get stored description data from card attributes
		const descriptionData = card.getAttribute("data-descriptions");
		if (descriptionData) {
			try {
				const descriptions = JSON.parse(descriptionData);
				const newDescription = descriptions[selectedCategory] || descriptions["all"] || "";
				descriptionElement.textContent = newDescription;
			} catch (e) {
				// Fallback to original description if JSON parsing fails
			}
		}
	};

	const updateExpandButtonVisibility = (visibleCount: number) => {
		const expandButton = document.getElementById("expandButton");
		if (!expandButton) return;

		const threshold = getCardsPerRowThreshold();

		if (visibleCount > threshold) {
			canExpand = true;
			expandButton.style.display = "flex";
			applyExpandState();
		} else {
			canExpand = false;
			expandButton.style.display = "none";
			applyExpandState();
		}
	};

	const tabButtons = document.querySelectorAll(".tab");
	tabButtons.forEach(button => {
		button.addEventListener("click", () => {
			const buttonElement = button;

			tabButtons.forEach(tab => tab.classList.remove("active"));

			buttonElement.classList.add("active");

			const category = buttonElement.getAttribute("data-category") || "all";

			sortCards(category);
		});
	});

	const totalCards = getVisibleCards(Array.from(document.querySelectorAll(".card")) as HTMLElement[]).length;
	updateExpandButtonVisibility(totalCards);
	applyExpandState();

	window.addEventListener("resize", () => {
		const allCards = getVisibleCards(Array.from(document.querySelectorAll(".card")) as HTMLElement[]);
		updateExpandButtonVisibility(allCards.length);
	});

	// Use the shared utility function for syncing add buttons
	const syncAllAddButtons = updateAddButtonStates;

	const updateCardHighlighting = () => {
		const cards = document.querySelectorAll(".card");
		cards.forEach(card => {
			const cardId = card.getAttribute("data-card-id");
			if (cardId) {
				if (isItemInterested(cardId)) {
					card.classList.add("highlighted");
				} else {
					card.classList.remove("highlighted");
				}
			}
		});
	};

	const updateInterestButton = () => {
		const items = getInterestedItems();
		const countElement = document.querySelector(".interest-count");

		if (countElement) {
			if (items.length > 0) {
				countElement.textContent = items.length.toString();
			} else {
				countElement.textContent = "";
			}
		}
	};

	const renderInterestItemsList = () => {
		const items = getInterestedItems();
		const listContainer = document.getElementById("interestItemsList");

		if (!listContainer) return;

		if (items.length === 0) {
			listContainer.innerHTML = `<div class="empty-state">${document.querySelector("[data-i18n-no-items]")?.textContent}</div>`;
			return;
		}

		listContainer.innerHTML = "";

		const removeIconTemplate = document.getElementById("removeIconTemplate") as HTMLTemplateElement | null;

		items.forEach(item => {
			const itemDiv = document.createElement("div");
			itemDiv.className = "interest-item";
			itemDiv.setAttribute("data-item-id", item.id);

			const contentDiv = document.createElement("div");
			contentDiv.className = "item-content";

			const titleSpan = document.createElement("span");
			titleSpan.className = "item-title";
			titleSpan.textContent = item.title;

			const removeButton = document.createElement("button");
			removeButton.className = "remove-item";
			removeButton.setAttribute("data-item-id", item.id);

			if (removeIconTemplate) {
				const iconClone = removeIconTemplate.content.cloneNode(true);
				removeButton.appendChild(iconClone);
			}

			contentDiv.appendChild(titleSpan);
			contentDiv.appendChild(removeButton);
			itemDiv.appendChild(contentDiv);
			listContainer.appendChild(itemDiv);
		});

		const removeButtons = listContainer.querySelectorAll(".remove-item");
		removeButtons.forEach(button => {
			button.addEventListener("click", e => {
				e.stopPropagation();
				const itemId = button.getAttribute("data-item-id") || "";
				removeInterestedItem(itemId);
			});
		});
	};

	let previousInterestCount = getInterestedItems().length;

	window.addEventListener("itemsChange", (e: Event) => {
		updateInterestButton();
		renderInterestItemsList();
		updateCardHighlighting();

		let currentCount = previousInterestCount;
		try {
			const ce = e as CustomEvent<{ items?: unknown[] }>;
			if (ce?.detail && Array.isArray(ce.detail.items)) {
				currentCount = ce.detail.items.length;
			} else {
				currentCount = getInterestedItems().length;
			}
		} catch {
			currentCount = getInterestedItems().length;
		}

		if (currentCount > previousInterestCount) {
			setTimeout(() => openPopover(), 0);
		}

		previousInterestCount = currentCount;
	});

	const interestButton = document.getElementById("interestButton");
	const interestPopover = document.getElementById("interestPopover");

	const openPopover = () => {
		if (interestPopover) {
			renderInterestItemsList();
			interestPopover.classList.add("active");
		}
	};

	const closePopover = () => {
		if (interestPopover) {
			interestPopover.classList.remove("active");
		}
	};

	if (interestButton) {
		interestButton.addEventListener("click", e => {
			e.stopPropagation();
			if (interestPopover?.classList.contains("active")) {
				closePopover();
			} else {
				openPopover();
			}
		});
	}

	// Consolidated click event listener for all click interactions
	document.addEventListener("click", e => {
		const target = e.target;
		if (!(target instanceof Element)) return;

		// Note: Add button clicks are now handled by the global handler in add-to-cart-handler.ts

		// Handle popover close when clicking outside
		if (interestPopover?.classList.contains("active") && !interestPopover.contains(e.target as Node) && !interestButton?.contains(e.target as Node)) {
			closePopover();
			return;
		}

		// Handle download quote button
		if (target.closest(".download-quote-btn")) {
			e.preventDefault();
			const quotationUrl = window.location.origin + "/2026/cfs/quotation";
			window.open(quotationUrl, "_blank");
			closePopover();
			return;
		}

		// Handle view plan details button
		if (target.closest(".view-plan-btn")) {
			e.preventDefault();

			if (hasVisitedPlans) {
				// Navigate to Form section if user has already visited Plans
				const formSection = document.getElementById("form");
				if (formSection) {
					formSection.scrollIntoView({ behavior: "smooth" });
					closePopover();
				}
			} else {
				// Navigate to Plans section if user hasn't visited Plans yet
				const plansSection = document.getElementById("plans");
				if (plansSection) {
					plansSection.scrollIntoView({ behavior: "smooth" });
					closePopover();
					// Mark that user has visited plans
					hasVisitedPlans = true;
					updateViewPlanButtonText();
				}
			}
			return;
		}
	});

	document.addEventListener("keydown", e => {
		if (e.key === "Escape") {
			closePopover();
		}
	});

	updateInterestButton();
	syncAllAddButtons();

	const targetSections = ["items", "plans", "addons", "form"];
	let currentSection = "";
	let hasVisitedPlans = false;
	let isButtonVisible = false;

	// Store text constants for JavaScript access
	const viewPlanDetailsText = document.getElementById("viewPlanBtnText")?.textContent || "檢視方案詳情";
	const contactUsText = "聯絡我們";

	const updateViewPlanButtonText = () => {
		const viewPlanBtnText = document.getElementById("viewPlanBtnText");
		if (viewPlanBtnText) {
			if (hasVisitedPlans) {
				viewPlanBtnText.textContent = contactUsText;
			} else {
				viewPlanBtnText.textContent = viewPlanDetailsText;
			}
		}
	};

	const updateInterestButtonVisibility = () => {
		const interestButtons = document.querySelectorAll(".interest-button");

		// Check if user is within the range of target sections
		let isWithinTargetRange = false;
		let foundSection = "";

		// Determine which section is most visible for tracking purposes
		for (const sectionName of targetSections) {
			const section = document.getElementById(sectionName);
			if (section) {
				const rect = section.getBoundingClientRect();
				const sectionHeight = rect.height;
				const visibleHeight = Math.min(rect.bottom, window.innerHeight) - Math.max(rect.top, 0);

				if (visibleHeight > sectionHeight * 0.3) {
					foundSection = sectionName;
					break;
				}
			}
		}

		// Update current section if it changed
		if (foundSection && foundSection !== currentSection) {
			currentSection = foundSection;

			// Check if user has visited the plans section
			if (foundSection === "plans" && !hasVisitedPlans) {
				hasVisitedPlans = true;
				updateViewPlanButtonText();
			}
		}

		// Calculate if user is within the range of target sections
		const firstSection = document.getElementById(targetSections[0]);
		const lastSection = document.getElementById(targetSections[targetSections.length - 1]);

		if (firstSection && lastSection) {
			const firstRect = firstSection.getBoundingClientRect();
			const lastRect = lastSection.getBoundingClientRect();

			const viewportBottom = window.innerHeight;

			isWithinTargetRange = firstRect.top < viewportBottom && lastRect.bottom > 0;
		}

		// Show/hide button based on whether user is within target range
		// Only update DOM if visibility state has changed
		if (isWithinTargetRange !== isButtonVisible) {
			isButtonVisible = isWithinTargetRange;
			interestButtons.forEach(button => {
				const buttonElement = button as HTMLElement;
				buttonElement.style.display = isWithinTargetRange ? "flex" : "none";
			});
		}
	};

	let scrollTimeout: number | undefined;
	const handleScroll = () => {
		if (scrollTimeout) {
			cancelAnimationFrame(scrollTimeout);
		}
		scrollTimeout = requestAnimationFrame(updateInterestButtonVisibility);
	};

	document.addEventListener("scroll", handleScroll);
	window.addEventListener("resize", updateInterestButtonVisibility);

	setTimeout(updateInterestButtonVisibility, 100);
	window.addEventListener("itemsChange", syncAllAddButtons);
	document.addEventListener("interested-items-changed", updateCardHighlighting);
	updateCardHighlighting();
</script>

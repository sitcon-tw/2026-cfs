---
const { t } = Astro.props;
import { Container } from "@lucide/astro";
import Popup from "../Popup.astro";
import plansData from "../../data/plans_data.json";
import itemsData from "../../data/items_data.json";
---

<section id="plans">
	<h2>{t.title}</h2>
	<div class="container">
		<div class="plans-table">
			<div class="plans-header">
				{
					plansData.tiers.map((tier: any) => (
						<div class="tier-column">
							<div class="tier-name" style={`color: ${tier.textColor}`}>
								{t.tier_names[tier.name]}
							</div>
							<div class="tier-price">{tier.price}</div>
						</div>
					))
				}
			</div>

			<div class="plans-content">
				{
					plansData.rows.map((row: any) => (
						<div class="plan-row" data-row-id={row.id}>
							{row.values.map((value: any, index: number) => {
								// Handle number + unit structure
								const hasNumber = value.number !== undefined;
								const mainText = value.textKey ? t.features[value.textKey] : (value.main || '');
								const subText = value.subKey ? t.features[value.subKey] : (value.sub || '');
								const unitText = value.unitKey ? t.unit[value.unitKey.split('.').pop()] : '';

								return (
									<div class="plan-cell">
										{value.icon && (
											<div class="cell-icon">
												{Array.from({ length: value.icon }, (_, i) => (
													<Container key={i} />
												))}
											</div>
										)}
										{hasNumber ? (
											<div class="cell-main cell-number">
												{value.number} {unitText}
											</div>
										) : (
											<div class="cell-main cell-text">{mainText}</div>
										)}
										{subText && <div class="cell-sub">{subText}</div>}
									</div>
								);
							})}
						</div>
					))
				}
			</div>
		</div>
	</div>
</section>

{
	plansData.rows.map((row: any) => {
		const matchingItem = itemsData.find((item: any) => item.id === row.id);
		if (matchingItem) {
			return (
				<Popup
					id={`plan-popup-${row.id}`}
					title={t.item_titles[matchingItem.title]}
					background={matchingItem.image}
					btnText=""
					hero={true}
				>
					<div class="popup-content">
						<div class="item-details">
							<h3>{t.item_titles[matchingItem.title]}</h3>
							<p class="item-description">{t.item_descriptions[matchingItem.description]}</p>
							<div class="item-meta">
								<span class="remaining">{matchingItem.remaining} {t.unit[matchingItem.unit]} {t.remaining}</span>
								<span class="category">{t.item_categories[matchingItem.category]}</span>
							</div>
						</div>

						<div class="plan-comparison">
							<h4>{t.plan_comparison}</h4>
							<div class="tier-comparison">
								{row.values.map((value: any, index: number) => {
									const tier = plansData.tiers[index];
									const hasNumber = value.number !== undefined;
									const mainText = value.textKey ? t.features[value.textKey] : (value.main || '');
									const subText = value.subKey ? t.features[value.subKey] : (value.sub || '');
									const unitText = value.unitKey ? t.unit[value.unitKey.split('.').pop()] : '';

									return (
										<div class="tier-item" style={`border-color: ${tier.textColor}`}>
											<div class="tier-name" style={`color: ${tier.textColor}`}>
												{t.tier_names[tier.name]}
											</div>
											<div class="tier-value">
												{value.icon && (
													<div class="tier-icons">
														{Array.from({ length: value.icon }, (_, i) => (
															<Container key={i} />
														))}
													</div>
												)}
												{hasNumber ? (
													<div class="tier-number">
														{value.number} {unitText}
													</div>
												) : (
													<div class="tier-text">{mainText}</div>
												)}
												{subText && <div class="tier-sub">{subText}</div>}
											</div>
										</div>
									);
								})}
							</div>
						</div>
					</div>
				</Popup>
			);
		}
	})
}

<script>
	import { isItemInterested } from "../../utils/local-storage.ts";

	function updateHighlighting() {
		const planRows = document.querySelectorAll(".plan-row");
		planRows.forEach(row => {
			const rowIdStr = row.getAttribute("data-row-id");
			if (rowIdStr) {
				const rowId = parseInt(rowIdStr);
				const isHighlighted = isItemInterested(rowId);

				const clickableCells = row.querySelectorAll(".plan-cell");
				clickableCells.forEach(cell => {
					if (isHighlighted) {
						cell.classList.add("highlighted");
					} else {
						cell.classList.remove("highlighted");
					}
				});
			}
		});
	}

	function addRowClickHandlers() {
		const planRows = document.querySelectorAll(".plan-row") as NodeListOf<HTMLElement>;
		planRows.forEach(row => {
			const rowIdStr = row.getAttribute("data-row-id");
			if (rowIdStr) {
				row.style.cursor = "pointer";
				row.addEventListener("click", function(e) {
					e.stopPropagation();
					const popupId = `plan-popup-${rowIdStr}`;
					const popup = document.querySelector(`#${popupId} + .popup-bg`) as HTMLElement;
					if (popup) {
						popup.style.display = "block";
						setTimeout(() => {
							popup.scrollTo({ top: 0 });
							popup.classList.add("show");
						}, 0);
					}
				});
			}
		});
	}

	document.addEventListener("DOMContentLoaded", function() {
		updateHighlighting();
		addRowClickHandlers();
	});

	window.addEventListener("itemsChange", updateHighlighting);
	document.addEventListener("interested-items-changed", updateHighlighting);
</script>

<style>
	section {
		background-color: var(--items-bg);
		padding: 5rem 0;
	}
	.container {
		max-width: 100rem;
		border-radius: 2rem;
		background-color: var(--white);
		width: calc(100% - 4rem);
		margin: 0 auto;
		padding: 5rem;
		flex: auto;
		display: flex;
		justify-content: center;
	}

	h2 {
		font-size: 3rem;
		color: var(--black);
		text-align: center;
		margin-bottom: 3rem;
		font-weight: 700;
	}

	.plans-table {
		max-width: 1200px;
		background-color: var(--white);
		border-radius: 2rem;
		overflow: hidden;
		padding: 2rem;
	}

	.plans-header {
		display: grid;
		grid-template-columns: repeat(4, 1fr);
		gap: 2rem;
		margin-bottom: 2rem;
		padding-bottom: 2rem;
	}

	.tier-column {
		text-align: center;
		position: relative;
	}

	.tier-column::after {
		content: "";
		position: absolute;
		bottom: -2rem;
		left: 10%;
		right: 10%;
		height: 1px;
		background-color: var(--border-light);
	}

	.tier-name {
		font-size: 3rem;
		font-weight: 700;
		margin-bottom: 0.5rem;
		line-height: 1.2;
	}

	.tier-price {
		font-size: 2rem;
		font-weight: 600;
		color: var(--black);
	}

	.plans-content {
		display: grid;
		gap: 1rem;
	}

	.plan-row {
		display: grid;
		grid-template-columns: repeat(4, 1fr);
		gap: 2rem;
		padding: 1rem 0;
	}

	.plan-cell {
		text-align: center;
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 0.5rem;
	}


	.plan-cell.highlighted .cell-main,
	.plan-cell.highlighted .cell-sub,
	.plan-cell.highlighted .cell-icon {
		color: var(--items-green);
		font-weight: 600;
	}

	.cell-icon {
		display: flex;
		gap: 0.25rem;
		justify-content: center;
		margin-bottom: 0.5rem;
	}

	.cell-icon svg {
		width: 1.25rem;
		height: 1.25rem;
	}

	.cell-main {
		line-height: 1.3;
	}

	.cell-number {
		font-size: 2rem;
		font-weight: bold;
		color: var(--black);
	}

	.cell-text {
		font-size: 1rem;
		font-weight: normal;
		color: var(--black);
	}

	.cell-sub {
		font-size: 1rem;
		color: var(--black);
		line-height: 1.2;
	}

	@media (max-width: 1024px) {
		.plans-table {
			width: (100% - 2rem);
			overflow-x: auto;
			padding: 1.5rem;
		}

		.tier-name {
			font-size: 2rem;
		}

		.tier-price {
			font-size: 1.5rem;
		}

		.plans-header,
		.plan-row {
			min-width: 800px;
		}

		h2 {
			font-size: 2.5rem;
		}
	}

	@media (max-width: 768px) {
		.container {
			width: (100% - 2rem);
			padding: 2rem 1rem;
		}

		.plans-table {
			padding: 1rem;
		}

		h2 {
			font-size: 2rem;
			margin-bottom: 2rem;
		}

		.tier-name {
			font-size: 1.2rem;
		}

		.tier-price {
			font-size: 1rem;
		}

		.plans-header,
		.plan-row {
			gap: 1rem;
			min-width: 600px;
		}

		.cell-main {
			font-size: 0.9rem;
		}

		.cell-sub {
			font-size: 0.8rem;
		}
	}

	@media (max-width: 480px) {
		section {
			width: (100% - 2rem);
			padding: 2rem 0;
		}

		h2 {
			font-size: 1.8rem;
		}

		.plans-table {
			padding: 0.75rem;
		}

		.plans-header,
		.plan-row {
			min-width: 500px;
		}
	}

	/* Plan row hover effect */
	.plan-row:hover {
		background-color: var(--items-bg);
		border-radius: 0.5rem;
		transition: background-color 0.2s ease;
	}
</style>

<style is:global>
	/* Popup content styling */
	.popup-content {
		padding: 2rem 5rem;
		display: flex;
		flex-direction: column;
		gap: 3rem;
	}

	.item-details h3 {
		font-size: 2.5rem;
		color: var(--black);
		margin-bottom: 1rem;
		font-weight: 700;
	}

	.item-description {
		font-size: 1.2rem;
		line-height: 1.6;
		color: var(--black);
		margin-bottom: 1.5rem;
	}

	.item-meta {
		display: flex;
		gap: 2rem;
		align-items: center;
	}

	.remaining {
		background-color: var(--items-green);
		color: white;
		padding: 0.5rem 1rem;
		border-radius: 1rem;
		font-weight: 600;
		font-size: 0.9rem;
	}

	.category {
		background-color: var(--gray);
		color: var(--black);
		padding: 0.5rem 1rem;
		border-radius: 1rem;
		font-weight: 500;
		font-size: 0.9rem;
	}

	.plan-comparison h4 {
		font-size: 2rem;
		color: var(--black);
		margin-bottom: 2rem;
		font-weight: 600;
	}

	.tier-comparison {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: 1.5rem;
	}

	.tier-item {
		border: 2px solid;
		border-radius: 1rem;
		padding: 1.5rem;
		background-color: var(--white);
	}

	.tier-name {
		font-size: 1.5rem;
		font-weight: 700;
		margin-bottom: 1rem;
		text-align: center;
	}

	.tier-value {
		text-align: center;
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.tier-icons {
		display: flex;
		gap: 0.25rem;
		justify-content: center;
		margin-bottom: 0.5rem;
	}

	.tier-icons svg {
		width: 1.25rem;
		height: 1.25rem;
	}

	.tier-number {
		font-size: 1.5rem;
		font-weight: bold;
		color: var(--black);
	}

	.tier-text {
		font-size: 1rem;
		color: var(--black);
	}

	.tier-sub {
		font-size: 0.9rem;
		color: var(--black);
		opacity: 0.8;
	}

	@media (max-width: 768px) {
		.popup-content {
			padding: 1.5rem 2rem;
			gap: 2rem;
		}

		.item-details h3 {
			font-size: 2rem;
		}

		.plan-comparison h4 {
			font-size: 1.5rem;
		}

		.tier-comparison {
			grid-template-columns: 1fr;
		}
	}
</style>
